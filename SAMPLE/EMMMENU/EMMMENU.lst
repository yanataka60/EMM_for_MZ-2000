                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.28.0, LST:Full:4
       00B1                     MONITOR     EQU     00B1H
       05F3                     PRTBYT      EQU     05F3H
       06A4                     GETL        EQU     06A4H
       0832                     GETKEY      EQU     0832H
       0889                     MSGPR       EQU     0889H
       08C6                     PRNT        EQU     08C6H
       0A2E                     LETLN       EQU     0A2EH
       10AB                     LBUF        EQU     10ABH
       1140                     IBUFE       EQU     1140H
       1141                     FNAME       EQU     1141H
       1152                     FSIZE       EQU     1152H
       1154                     SADRS       EQU     1154H
       F803                     MSHED       EQU     0F803H
       F806                     MSDAT       EQU     0F806H
       F80C                     MLDAT       EQU     0F80CH
       F9AF                     DIRLIST     EQU     0F9AFH
       FD5D                     MLHED2      EQU     0FD5DH
       FDEE                     CMPSTR      EQU     0FDEEH
       FE02                     CMD1        EQU     0FE02H
                                
       00A4                     EMM     EQU     0A4H
                                
                                
                                
000000 12A0                             ORG 12A0H
                                
000000 12A0 11AE14          10          LD  DE,TITLE            ;'******** EMMLOAD,EMMSAVE MENU ********'表示
000003 12A3 CD8908          17          CALL    MSGPR
000006 12A6 CD2E0A          17          CALL    LETLN
000009 12A9 CD2E0A          17  MENU:       CALL    LETLN
00000C 12AC 11D514          10          LD  DE,EMENU            ;'1)EMM1 2)EMM2 3)EMM3 4)EXIT?'表示
00000F 12AF CD8908          17          CALL    MSGPR
000012 12B2 CD3208          17  EKEY:       CALL    GETKEY              ;1文字入力待ち
000015 12B5 FE00             7          CP  00H
000017 12B7 28F9            12          JR  Z,EKEY
000019 12B9 47               4          LD  B,A
00001A 12BA FE31             7  EMM1:       CP  '1'             ;EMM1
00001C 12BC 200A            12          JR  NZ,EMM2
00001E 12BE CDC608          17          CALL    PRNT
000021 12C1 3EA4             7          LD  A,0A4H              ;EMM I/Oアドレス A4H
000023 12C3 CD8D14          17          CALL    EMMADRS
000026 12C6 1826            12          JR  MENUS
000028 12C8 FE32             7  EMM2:       CP  '2'             ;EMM2
00002A 12CA 200A            12          JR  NZ,EMM3
00002C 12CC CDC608          17          CALL    PRNT
00002F 12CF 3EA8             7          LD  A,0A8H              ;EMM I/Oアドレス A8H
000031 12D1 CD8D14          17          CALL    EMMADRS
000034 12D4 1818            12          JR  MENUS
000036 12D6 FE33             7  EMM3:       CP  '3'             ;EMM3
000038 12D8 2008            12          JR  NZ,EMM4
00003A 12DA CDC608          17          CALL    PRNT
00003D 12DD 3EAC             7          LD  A,0ACH              ;EMM I/Oアドレス ACH
00003F 12DF CD8D14          17          CALL    EMMADRS
000042 12E2 FE34             7  EMM4:       CP  '4'             ;EXIT
000044 12E4 20C3            12          JR  NZ,MENU
000046 12E6 CDC608          17          CALL    PRNT
000049 12E9 CD2E0A          17          CALL    LETLN
00004C 12EC 183D            12          JR  EXIT
                                        
                                    
00004E 12EE 78               4  MENUS:      LD  A,B
00004F 12EF 322A15          13          LD  (LNAME+8),A         ;EMM0～EMM3の文字を変更
000052 12F2 324B15          13          LD  (MSG1+3),A
000055 12F5 323415          13          LD  (SNAME+8),A
000058 12F8 326F15          13          LD  (MSG4+3),A
00005B 12FB CD2E0A          17  MS2:        CALL    LETLN
00005E 12FE 11F214          10          LD  DE,SMENU            ;'1)EMMLOAD 2)EMMSAVE 3)EXIT ?'表示
000061 1301 CD8908          17          CALL    MSGPR
000064 1304 CD3208          17  SKEY:       CALL    GETKEY              ;1文字入力待ち
000067 1307 FE00             7          CP  00H
000069 1309 28F9            12          JR  Z,SKEY
00006B 130B FE31             7          CP  '1'
00006D 130D 2008            12          JR  NZ,SK1
00006F 130F CDC608          17          CALL    PRNT
000072 1312 CD2E0A          17          CALL    LETLN
000075 1315 1820            12          JR  LSTART              ;EMMLOAD
000077 1317 FE32             7  SK1:        CP  '2'
000079 1319 2009            12          JR  NZ,SK2
00007B 131B CDC608          17          CALL    PRNT
00007E 131E CD2E0A          17          CALL    LETLN
000081 1321 C31414          10          JP  SSTART              ;EMMSAVE
000084 1324 FE33             7  SK2:        CP  '3'
000086 1326 20D3            12          JR  NZ,MS2
000088 1328 CDC608          17          CALL    PRNT
00008B 132B CD2E0A          17  EXIT:       CALL    LETLN
00008E 132E 110F15          10          LD  DE,ENDMSG           ;'Run Again:[J 12A0]'表示
000091 1331 CD8908          17          CALL    MSGPR
000094 1334 C3B100          10          JP  MONITOR
                                
       1337                     LSTART:
000097 1337 116515          10          LD  DE,MSG3             ;「FNAME:」を表示する
00009A 133A CD8908          17          CALL    MSGPR
00009D 133D 11AB10          10          LD  DE,LBUF             ;DOSファイル名を入力
0000A0 1340 CDA406          17          CALL    GETL
0000A3 1343 3AAB10          13          LD  A,(LBUF)
0000A6 1346 FE0B             7          CP  0BH             ;BREAKキーが押されたらキャンセル
0000A8 1348 CA2B13          10          JP  Z,EXIT
0000AB 134B 11B110          10          LD  DE,LBUF+6           ;DOSファイル名をCHECK
0000AE 134E 1A               7          LD  A,(DE)
0000AF 134F FE0D             7  ST1:        CP  0DH             ;入力なしならDefaultの「PIO3034_1」～「PIO3034_3」を採用
0000B1 1351 2860            12          JR  Z,ST0
0000B3 1353 FE20             7          CP  ' '             ;SPACEは読み飛ばし
0000B5 1355 2003            12          JR  NZ,ST2
0000B7 1357 13               6          INC DE
0000B8 1358 18F5            12          JR  ST1
0000BA 135A FE2A             7  ST2:        CP  '*'             ;*が入力されたら「*FDL」処理へ
0000BC 135C 280A            12          JR  Z,ST3
0000BE 135E ED530F14        20          LD  (ML0+1),DE          ;DOSファイル名が入力されていたらそちらを採用
0000C2 1362 ED53B713        20          LD  (ML1+1),DE
0000C6 1366 184B            12          JR  ST0
                                
                                ;**** FDL処理 ****
       1368                     ST3:
                                ;**** HL、DE、BCレジスタを保存 ****
0000C8 1368 E5              11          PUSH    HL
0000C9 1369 D5              11          PUSH    DE
0000CA 136A C5              11          PUSH    BC
0000CB 136B 13               6          INC DE
0000CC 136C 0603             7          LD  B,03H
                                ;**** FDLコマンド ****
0000CE 136E 2102FE          10          LD  HL,CMD1             ;「*FDL」と入力されているかチェック
0000D1 1371 CDEEFD          17          CALL    CMPSTR
0000D4 1374 2805            12          JR  Z,MLHCMD2
0000D6 1376 C1              10          POP BC
0000D7 1377 D1              10          POP DE
0000D8 1378 E1              10          POP HL
                                ;**** DOSファイル名入力へ復帰 ****
0000D9 1379 18BC            12          JR  LSTART              ;そうでなければ「*FDL」処理を中止
                                
       137B                     MLHCMD2:
0000DB 137B 13               6          INC DE
0000DC 137C 13               6          INC DE
0000DD 137D 13               6          INC DE
0000DE 137E 216515          10          LD  HL,MSG3             ;行頭に'FNAME:'を付けることでカーソルを移動させリターンで実行できるように
0000E1 1381 010600          10          LD  BC,MSG3END-MSG3
                                ;**** FDLコマンド呼び出し ****
0000E4 1384 CDAFF9          17          CALL    DIRLIST             ;*FDLの後に入力された文字列から始まるファイル名を一覧表示
0000E7 1387 A7               4          AND A               ;00以外ならERROR
0000E8 1388 2006            12          JR  NZ,SERR
0000EA 138A C1              10          POP BC
0000EB 138B D1              10          POP DE
0000EC 138C E1              10          POP HL
                                ;**** DOSファイル名入力へ復帰 ****
0000ED 138D C33713          10          JP  LSTART
                                
                                ;******* アプリケーション内SD-CARD操作処理用ERROR処理 **************
       1390                     SERR:
0000F0 1390 FEF0             7          CP  0F0H
0000F2 1392 2005            12          JR  NZ,SERR3
0000F4 1394 119615          10          LD  DE,MSG_F0
0000F7 1397 180F            12          JR  SERRMSG
                                        
0000F9 1399 FEF1             7  SERR3:  CP      0F1H
0000FB 139B 2005            12          JR  NZ,SERR99
0000FD 139D 11AF15          10          LD  DE,MSG_F1
000100 13A0 1806            12          JR  SERRMSG
                                        
000102 13A2 CDF305          17  SERR99: CALL    PRTBYT
000105 13A5 11BD15          10          LD  DE,MSG99
                                        
       13A8                     SERRMSG:
000108 13A8 CD8908          17          CALL    MSGPR
00010B 13AB CD2E0A          17          CALL    LETLN
00010E 13AE C1              10          POP BC
00010F 13AF D1              10          POP DE
000110 13B0 E1              10          POP HL
                                ;**** DOSファイル名入力へ復帰 ****
000111 13B1 1884            12          JR  LSTART
                                
                                ;********************************** EMMLOAD処理本体 ************************************
000113 13B3 CD2E0A          17  ST0:        CALL    LETLN
000116 13B6 112215          10  ML1:        LD  DE,LNAME                ;DOSファイル名表示
000119 13B9 CD8908          17          CALL    MSGPR
00011C 13BC 113B15          10          LD  DE,MSG0             ;' LOAD START!'表示
00011F 13BF CD8908          17          CALL    MSGPR
                                
000122 13C2 CD8514          17          CALL    EMMRESET
                                
000125 13C5 CD0B14          17          CALL    MLHED               ;DOSファイル名をArduinoに送信してファイルオープン
000128 13C8 DA2B13          10          JP  C,EXIT              ;DOSファイル名のファイルが存在しない等のエラーがあれば中止
                                        
00012B 13CB 210080          10          LD  HL,8000H            ;IFBにファイル長(8000H)をセット
00012E 13CE 225211          16          LD  (FSIZE),HL
000131 13D1 21C415          10          LD  HL,BUFF
000134 13D4 225411          16          LD  (SADRS),HL          ;IFBにメインメモリ格納先頭アドレス(BUFF)をセット
000137 13D7 0610             7          LD  B,10H               ;SDからのLOADを8000H(32KB)を16回繰り返し
000139 13D9 0E30             7          LD  C,30H               ;ブロック名として0～Fを便宜的に表示
                                        
00013B 13DB C5              11  LOP2:       PUSH    BC
00013C 13DC E5              11          PUSH    HL
00013D 13DD D5              11          PUSH    DE
00013E 13DE CDA014          17          CALL    BPRINT
000141 13E1 115615          10          LD  DE,MSG2             ;' BLOCK LOADING'を表示
000144 13E4 CD8908          17          CALL    MSGPR
000147 13E7 D1              10          POP DE
000148 13E8 E1              10          POP HL
                                
000149 13E9 CD0CF8          17          CALL    MLDAT               ;Arduinoから1ブロックを読み込み
                                        
00014C 13EC 21C415          10          LD  HL,BUFF
00014F 13EF 110080          10          LD  DE,8000H
       13F2                     LOP1:       
000152 13F2 7E               7          LD  A,(HL)
000153 13F3 D3A7            11  ML3:        OUT (EMM+3),A           ;BUFFから8000H(32KB)を1Byteずつ読み込み、EMMへ書き込み
000155 13F5 23               6          INC HL
000156 13F6 1B               6          DEC DE
000157 13F7 7B               4          LD  A,E
000158 13F8 B2               4          OR  D
000159 13F9 20F7            12          JR  NZ,LOP1             ;32KB分ループ
                                
00015B 13FB C1              10          POP BC
00015C 13FC 0C               4          INC C
00015D 13FD 10DC            13          DJNZ    LOP2                ;16回ループ
                                        
00015F 13FF CD2E0A          17          CALL    LETLN
000162 1402 114815          10          LD  DE,MSG1             ;'EMMx LOAD END'を表示
000165 1405 CD8908          17          CALL    MSGPR
000168 1408 C32B13          10          JP  EXIT                ;終了
                                
                                ;************************ セットされたDOSファイル名でファイルオープンするためのMLHED処理 **************
00016B 140B D5              11  MLHED:      PUSH    DE
00016C 140C C5              11          PUSH    BC
00016D 140D E5              11          PUSH    HL
00016E 140E 112215          10  ML0:        LD  DE,LNAME
000171 1411 C35DFD          10          JP  MLHED2
                                
                                ;**************************** EMMSAVE ***************************************************
       1414                     SSTART:
000174 1414 CD2E0A          17          CALL    LETLN
000177 1417 112C15          10          LD  DE,SNAME            ;DOSファイル名表示
00017A 141A CD8908          17          CALL    MSGPR
00017D 141D 118915          10          LD  DE,MSG6             ;' SAVE START!'表示
000180 1420 CD8908          17          CALL    MSGPR
                                
000183 1423 CD8514          17          CALL    EMMRESET
000186 1426 3E01             7          LD  A,01H               ;IFBにファイル種別をセット(実は値が何でもOK)
000188 1428 324011          13          LD  (IBUFE),A
00018B 142B 212C15          10          LD  HL,SNAME                ;IFBにファイル名をセット(実は値が何でもOK)
00018E 142E 114111          10          LD  DE,FNAME
000191 1431 011000          10          LD  BC,10H
000194 1434 EDB0                        LDIR
                                        
000196 1436 210080          10          LD  HL,8000H            ;IFBにファイル長をセット(実は値が何でもOK)
000199 1439 225211          16          LD  (FSIZE),HL
00019C 143C 21C415          10          LD  HL,BUFF             ;IFBにメインメモリ格納先頭アドレスをセット(実は値が何でもOK)
00019F 143F 225411          16          LD  (SADRS),HL
                                
0001A2 1442 CD03F8          17          CALL    MSHED               ;ArduinoにIFBを送信、DOSファイルオープン
                                        
0001A5 1445 210080          10          LD  HL,8000H            ;IFBにファイル長(8000H)をセット
0001A8 1448 225211          16          LD  (FSIZE),HL
0001AB 144B 21C415          10          LD  HL,BUFF
0001AE 144E 225411          16          LD  (SADRS),HL          ;IFBにメインメモリ格納先頭アドレス(BUFF)をセット
0001B1 1451 0610             7          LD  B,10H               ;EMMから8000H(32KB)分読み出しを16回繰り返し
0001B3 1453 0E30             7          LD  C,30H               ;ブロック名として0～Fを便宜的に表示
                                        
0001B5 1455 C5              11  LOP3:       PUSH    BC
                                
0001B6 1456 E5              11          PUSH    HL
0001B7 1457 D5              11          PUSH    DE
0001B8 1458 CDA014          17          CALL    BPRINT
0001BB 145B 117A15          10          LD  DE,MSG5             ;' BLOCK SAVEING'を表示
0001BE 145E CD8908          17          CALL    MSGPR
0001C1 1461 D1              10          POP DE
0001C2 1462 E1              10          POP HL
                                
0001C3 1463 21C415          10          LD  HL,BUFF
0001C6 1466 110080          10          LD  DE,8000H
       1469                     LOP4:
       1469                     ML4:        
0001C9 1469 DBA7            11          IN  A,(EMM+3)           ;EMMから8000H(32KB)分読み出してBUFFへ書き込み
0001CB 146B 77               7          LD  (HL),A
0001CC 146C 23               6          INC HL
0001CD 146D 1B               6          DEC DE
0001CE 146E 7B               4          LD  A,E
0001CF 146F B2               4          OR  D
0001D0 1470 20F7            12          JR  NZ,LOP4             ;32KB分ループ
                                        
0001D2 1472 CD06F8          17          CALL    MSDAT               ;Arduinoへ1ブロックを送信し、SDへ書き込み
                                
0001D5 1475 C1              10          POP BC
0001D6 1476 0C               4          INC C
0001D7 1477 10DC            13          DJNZ    LOP3                ;16回ループ
                                        
0001D9 1479 CD2E0A          17          CALL    LETLN
0001DC 147C 116C15          10          LD  DE,MSG4             ;'EMMx SAVE END'を表示
0001DF 147F CD8908          17          CALL    MSGPR
0001E2 1482 C32B13          10          JP  EXIT                ;終了
                                
                                
       1485                     EMMRESET:
0001E5 1485 AF               4          XOR A               ;EMMアドレスリセット
0001E6 1486 D3A4            11  ML2:        OUT (EMM),A
0001E8 1488 D3A5            11          OUT (EMM+1),A
0001EA 148A D3A6            11          OUT (EMM+2),A
0001EC 148C C9              10          RET
                                
       148D                     EMMADRS:
0001ED 148D 328714          13          LD  (ML2+1),A
0001F0 1490 3C               4          INC A
0001F1 1491 328914          13          LD  (ML2+3),A
0001F4 1494 3C               4          INC A
0001F5 1495 328B14          13          LD  (ML2+5),A
0001F8 1498 3C               4          INC A
0001F9 1499 32F413          13          LD  (ML3+1),A
0001FC 149C 326A14          13          LD  (ML4+1),A
0001FF 149F C9              10          RET
                                
       14A0                     BPRINT:
000200 14A0 CD2E0A          17          CALL    LETLN
000203 14A3 79               4          LD  A,C             ;ブロック名としてA～Fを表示するための処理
000204 14A4 FE3A             7          CP  3AH
000206 14A6 3802            12          JR  C,ALPHA
000208 14A8 C607             7          ADD A,07H
00020A 14AA CDC608          17  ALPHA:      CALL    PRNT
00020D 14AD C9              10          RET
                                
       14AE                     TITLE:
00020E 14AE 2A2A2A2A2A2A2A2A            DB  '******** EMMLOAD,EMMSAVE MENU ********'
            20454D4D4C4F4144    
            2C454D4D53415645    
            204D454E55202A2A    
            2A2A2A2A2A2A        
000234 14D4 0D                          DB  0DH
                                
000235 14D5 3129454D4D312032    EMENU:      DB  '1)EMM1 2)EMM2 3)EMM3 4)EXIT?'
            29454D4D32203329    
            454D4D3320342945    
            5849543F            
000251 14F1 0D                          DB  0DH
                                
000252 14F2 3129454D4D4C4F41    SMENU:      DB  '1)EMMLOAD 2)EMMSAVE 3)EXIT ?'
            44203229454D4D53    
            4156452033294558    
            4954203F            
00026E 150E 0D                          DB  0DH
                                
00026F 150F 52756E2041676169    ENDMSG:     DB  'Run Again:[J 12A0]'
            6E3A5B4A20313241    
            305D                
000281 1521 0D                          DB  0DH
                                
       1522                     LNAME:
000282 1522 50494F333033345F            DB  'PIO3034_1'
            31                  
00028B 152B 0D                          DB  0DH
       152C                     NAME_END:
                                
       152C                     SNAME:
00028C 152C 50494F333033342D            DB  'PIO3034-1-SAVE'
            312D53415645        
00029A 153A 0D                          DB  0DH
       153B                     SNAME_END:
                                
                                
00029B 153B 204C4F4144205354    MSG0:       DB  ' LOAD START!'
            41525421            
0002A7 1547 0D                          DB  0DH
                                
       1548                     MSG1:
0002A8 1548 454D4D31204C4F41            DB  'EMM1 LOAD END'
            4420454E44          
0002B5 1555 0D                          DB  0DH
                                
0002B6 1556 20424C4F434B204C    MSG2:       DB  ' BLOCK LOADING'
            4F4144494E47        
0002C4 1564 0D                          DB  0DH
                                        
0002C5 1565 464E414D453A        MSG3:       DB  'FNAME:'
       156B                     MSG3END:
0002CB 156B 0D                          DB  0DH
                                
       156C                     MSG4:
0002CC 156C 454D4D3120534156            DB  'EMM1 SAVE END'
            4520454E44          
0002D9 1579 0D                          DB  0DH
                                
0002DA 157A 20424C4F434B2053    MSG5:       DB  ' BLOCK SAVEING'
            415645494E47        
0002E8 1588 0D                          DB  0DH
                                
0002E9 1589 2053415645205354    MSG6:       DB  ' SAVE START!'
            41525421            
0002F5 1595 0D                          DB  0DH
                                
       1596                     MSG_F0:
0002F6 1596 53442D4341524420            DB  'SD-CARD INITIALIZE ERROR'
            494E495449414C49    
            5A45204552524F52    
00030E 15AE 0D                          DB  0DH
                                        
       15AF                     MSG_F1:
00030F 15AF 4E4F542046494E44            DB  'NOT FIND FILE'
            2046494C45          
00031C 15BC 0D                          DB  0DH
                                        
       15BD                     MSG99:
00031D 15BD 204552524F52                DB  ' ERROR'
000323 15C3 0D                          DB  0DH
                                        
       15C4                     BUFF:
       15C4                             DS  8000H
                                        END
                                
[EOF:EMMMENU.s:UTF_8]
