                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.28.0, LST:Full:4
       00B1                     MONITOR     EQU     00B1H
       05F3                     PRTBYT      EQU     05F3H
       06A4                     GETL        EQU     06A4H
       0889                     MSGPR       EQU     0889H
       08C6                     PRNT        EQU     08C6H
       0A2E                     LETLN       EQU     0A2EH
       10AB                     LBUF        EQU     10ABH
       1152                     FSIZE       EQU     1152H
       1154                     SADRS       EQU     1154H
       F80C                     MLDAT       EQU     0F80CH
       F9AF                     DIRLIST     EQU     0F9AFH
       FD5D                     MLHED2      EQU     0FD5DH
       FDEE                     CMPSTR      EQU     0FDEEH
       FE02                     CMD1        EQU     0FE02H
                                
       0002                     EMM     EQU     2           ;指定したEMM番号用のEMMLOADを作成
                                
                                #if emm == 2                        ;EMM I/Oポート設定
       00A8                         EMM1        EQU     0A8H
                                #elif emm == 3
                                    EMM1        EQU     0ACH
                                #else
                                    EMM1        EQU     0A4H
                                #endif
                                
                                
                                
000000 12A0                             ORG 12A0H
                                
       12A0                     START:
000000 12A0 11BF13          10          LD  DE,MSG3             ;「FNAME:」を表示する
000003 12A3 CD8908          17          CALL    MSGPR
000006 12A6 11AB10          10          LD  DE,LBUF             ;DOSファイル名を入力
000009 12A9 CDA406          17          CALL    GETL
00000C 12AC 3AAB10          13          LD  A,(LBUF)
00000F 12AF FE0B             7          CP  0BH             ;BREAKキーが押されたらキャンセル
000011 12B1 CAB100          10          JP  Z,MONITOR
000014 12B4 11B110          10          LD  DE,LBUF+6           ;DOSファイル名をCHECK
000017 12B7 1A               7          LD  A,(DE)
000018 12B8 FE0D             7  ST1:        CP  0DH             ;入力なしならDefaultの「PIO3034_1」～「PIO3034_3」を採用
00001A 12BA 2860            12          JR  Z,ST0
00001C 12BC FE20             7          CP  ' '             ;SPACEは読み飛ばし
00001E 12BE 2003            12          JR  NZ,ST2
000020 12C0 13               6          INC DE
000021 12C1 18F5            12          JR  ST1
000023 12C3 FE2A             7  ST2:        CP  '*'             ;*が入力されたら「*FDL」処理へ
000025 12C5 280A            12          JR  Z,ST3
000027 12C7 ED538613        20          LD  (ML0+1),DE          ;DOSファイル名が入力されていたらそちらを採用
00002B 12CB ED532013        20          LD  (ML1+1),DE
00002F 12CF 184B            12          JR  ST0
                                
                                ;**** FDL処理 ****
       12D1                     ST3:
                                ;**** HL、DE、BCレジスタを保存 ****
000031 12D1 E5              11          PUSH    HL
000032 12D2 D5              11          PUSH    DE
000033 12D3 C5              11          PUSH    BC
000034 12D4 13               6          INC DE
000035 12D5 0603             7          LD  B,03H
                                ;**** FDLコマンド ****
000037 12D7 2102FE          10          LD  HL,CMD1             ;「*FDL」と入力されているかチェック
00003A 12DA CDEEFD          17          CALL    CMPSTR
00003D 12DD 2805            12          JR  Z,MLHCMD2
00003F 12DF C1              10          POP BC
000040 12E0 D1              10          POP DE
000041 12E1 E1              10          POP HL
                                ;**** DOSファイル名入力へ復帰 ****
000042 12E2 18BC            12          JR  START               ;そうでなければ「*FDL」処理を中止
                                
       12E4                     MLHCMD2:
000044 12E4 13               6          INC DE
000045 12E5 13               6          INC DE
000046 12E6 13               6          INC DE
000047 12E7 21BF13          10          LD  HL,MSG3             ;行頭に'FNAME:'を付けることでカーソルを移動させリターンで実行できるように
00004A 12EA 010600          10          LD  BC,MSG3END-MSG3
                                ;**** FDLコマンド呼び出し ****
00004D 12ED CDAFF9          17          CALL    DIRLIST             ;*FDLの後に入力された文字列から始まるファイル名を一覧表示
000050 12F0 A7               4          AND A               ;00以外ならERROR
000051 12F1 2006            12          JR  NZ,SERR
000053 12F3 C1              10          POP BC
000054 12F4 D1              10          POP DE
000055 12F5 E1              10          POP HL
                                ;**** DOSファイル名入力へ復帰 ****
000056 12F6 C3A012          10          JP  START
                                
                                ;******* アプリケーション内SD-CARD操作処理用ERROR処理 **************
       12F9                     SERR:
000059 12F9 FEF0             7          CP  0F0H
00005B 12FB 2005            12          JR  NZ,SERR3
00005D 12FD 11C613          10          LD  DE,MSG_F0
000060 1300 180F            12          JR  SERRMSG
                                        
000062 1302 FEF1             7  SERR3:  CP      0F1H
000064 1304 2005            12          JR  NZ,SERR99
000066 1306 11DF13          10          LD  DE,MSG_F1
000069 1309 1806            12          JR  SERRMSG
                                        
00006B 130B CDF305          17  SERR99: CALL    PRTBYT
00006E 130E 11ED13          10          LD  DE,MSG99
                                        
       1311                     SERRMSG:
000071 1311 CD8908          17          CALL    MSGPR
000074 1314 CD2E0A          17          CALL    LETLN
000077 1317 C1              10          POP BC
000078 1318 D1              10          POP DE
000079 1319 E1              10          POP HL
                                ;**** DOSファイル名入力へ復帰 ****
00007A 131A 1884            12          JR  START
                                
                                ;********************************** EMMLOAD処理本体 ************************************
00007C 131C CD2E0A          17  ST0:        CALL    LETLN
00007F 131F 118B13          10  ML1:        LD  DE,NAME             ;DOSファイル名表示
000082 1322 CD8908          17          CALL    MSGPR
000085 1325 119513          10          LD  DE,MSG0             ;' LOAD START!'表示
000088 1328 CD8908          17          CALL    MSGPR
                                
00008B 132B AF               4          XOR A               ;EMMアドレスリセット
00008C 132C D3A8            11          OUT (EMM1),A
00008E 132E D3A9            11          OUT (EMM1+1),A
000090 1330 D3AA            11          OUT (EMM1+2),A
                                
000092 1332 CD8213          17          CALL    MLHED               ;DOSファイル名をArduinoに送信してファイルオープン
000095 1335 DAB100          10          JP  C,MONITOR           ;DOSファイル名のファイルが存在しない等のエラーがあれば中止
                                        
000098 1338 210080          10          LD  HL,8000H            ;IFBにファイル長(8000H)をセット
00009B 133B 225211          16          LD  (FSIZE),HL
00009E 133E 21F413          10          LD  HL,BUFF
0000A1 1341 225411          16          LD  (SADRS),HL          ;IFBにメインメモリ格納先頭アドレス(BUFF)をセット
0000A4 1344 0610             7          LD  B,10H               ;SDからのLOADを8000H(32KB)を16回繰り返し
0000A6 1346 0E30             7          LD  C,30H               ;ブロック名として0～Fを便宜的に表示
                                        
0000A8 1348 C5              11  LOP2:       PUSH    BC
0000A9 1349 E5              11          PUSH    HL
0000AA 134A D5              11          PUSH    DE
0000AB 134B CD2E0A          17          CALL    LETLN
0000AE 134E 79               4          LD  A,C             ;ブロック名としてA～Fを表示するための処理
0000AF 134F FE3A             7          CP  3AH
0000B1 1351 3802            12          JR  C,ALPHA
0000B3 1353 C607             7          ADD A,07H
0000B5 1355 CDC608          17  ALPHA:      CALL    PRNT
0000B8 1358 11B013          10          LD  DE,MSG2             ;' BLOCK LOADING'を表示
0000BB 135B CD8908          17          CALL    MSGPR
0000BE 135E D1              10          POP DE
0000BF 135F E1              10          POP HL
                                
0000C0 1360 CD0CF8          17          CALL    MLDAT               ;Arduinoから1ブロックを読み込み
                                        
0000C3 1363 21F413          10          LD  HL,BUFF
0000C6 1366 110080          10          LD  DE,8000H
       1369                     LOP1:       
0000C9 1369 7E               7          LD  A,(HL)
0000CA 136A D3AB            11          OUT (EMM1+3),A          ;BUFFから8000H(32KB)を1Byteずつ読み込み、EMMへ書き込み
0000CC 136C 23               6          INC HL
0000CD 136D 1B               6          DEC DE
0000CE 136E 7B               4          LD  A,E
0000CF 136F B2               4          OR  D
0000D0 1370 20F7            12          JR  NZ,LOP1             ;32KB分ループ
                                
0000D2 1372 C1              10          POP BC
0000D3 1373 0C               4          INC C
0000D4 1374 10D2            13          DJNZ    LOP2                ;16回ループ
                                        
0000D6 1376 CD2E0A          17          CALL    LETLN
0000D9 1379 11A213          10          LD  DE,MSG1             ;'EMMx LOAD END'を表示
0000DC 137C CD8908          17          CALL    MSGPR
0000DF 137F C3B100          10          JP  MONITOR             ;終了
                                
                                ;************************ セットされたDOSファイル名でファイルオープンするためのMLHED処理 **************
0000E2 1382 D5              11  MLHED:      PUSH    DE
0000E3 1383 C5              11          PUSH    BC
0000E4 1384 E5              11          PUSH    HL
0000E5 1385 118B13          10  ML0:        LD  DE,NAME
0000E8 1388 C35DFD          10          JP  MLHED2
                                
       138B                     NAME:
                                
                                #if emm == 2
0000EB 138B 50494F333033345F            DB  'PIO3034_2'
            32                  
                                #elif emm == 3
                                        DB  'PIO3034_3'
                                #else
                                        DB  'PIO3034_1'
                                #endif
0000F4 1394 0D                          DB  0DH
       1395                     NAME_END:
                                
0000F5 1395 204C4F4144205354    MSG0:       DB  ' LOAD START!'
            41525421            
000101 13A1 0D                          DB  0DH
                                
       13A2                     MSG1:
                                #if emm == 2
000102 13A2 454D4D32204C4F41            DB  'EMM2 LOAD END'
            4420454E44          
                                #elif emm == 3
                                        DB  'EMM3 LOAD END'
                                #else
                                        DB  'EMM1 LOAD END'
                                #endif
00010F 13AF 0D                          DB  0DH
                                
000110 13B0 20424C4F434B204C    MSG2:       DB  ' BLOCK LOADING'
            4F4144494E47        
00011E 13BE 0D                          DB  0DH
                                        
00011F 13BF 464E414D453A        MSG3:       DB  'FNAME:'
       13C5                     MSG3END:
000125 13C5 0D                          DB  0DH
                                
       13C6                     MSG_F0:
000126 13C6 53442D4341524420            DB  'SD-CARD INITIALIZE ERROR'
            494E495449414C49    
            5A45204552524F52    
00013E 13DE 0D                          DB  0DH
                                        
       13DF                     MSG_F1:
00013F 13DF 4E4F542046494E44            DB  'NOT FIND FILE'
            2046494C45          
00014C 13EC 0D                          DB  0DH
                                        
       13ED                     MSG99:
00014D 13ED 204552524F52                DB  ' ERROR'
000153 13F3 0D                          DB  0DH
                                        
       13F4                     BUFF:
       13F4                             DS  8000H
                                        END
                                
[EOF:EMMLOAD.s:UTF_8]
